name: Deploy Hexo Blog

on:
  push:
    branches:
      - main
      # 🚨 优化1：确保只对主要的 Hexo 源代码仓库进行构建
      # 只有当你在本地或手机上提交文件到 main 分支时才触发部署

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source (Fetch Submodules)
        uses: actions/checkout@v4
        with:
          # ✅ 修复关键错误：启用子模块拉取，确保主题文件被下载
          submodules: true 
          # 确保拉取完整的历史记录，有助于正确处理子模块
          fetch-depth: 0 

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configure Git Credentials
        run: |
          # 配置 Git 信息，确保部署提交记录清晰
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: Install dependencies
        run: |
          npm install
          # 🚨 优化2：预先安装 Hexo-CLI，确保所有 Hexo 命令可用
          npm install hexo-cli -g

      - name: Deploy to GitHub Pages
        run: |
          # 1. 确保安装了部署插件
          npm install hexo-deployer-git
          
          # 2. 清理和生成静态文件
          npx hexo clean
          npx hexo generate
          
          # 3. 部署到目标仓库
          # ⚠️ 关键修复：直接在 URL 中使用 DEPLOY_TOKEN 进行身份验证
          # 这绕过了因 Actions 环境无法读取用户名/密码提示而导致的认证失败
          npx hexo deploy --repo https://${{ secrets.DEPLOY_TOKEN }}@github.com/RCsCC/RCsCC.github.io.git
          
        env:
          # 仅使用 GIT_DEPLOY_TOKEN 环境变量，确保 Hexo Deployer Git 插件能识别
          GIT_DEPLOY_TOKEN: ${{ secrets.DEPLOY_TOKEN }}